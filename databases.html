<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt" xml:lang="pt"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Mine Çetinkaya-Rundel, e Garrett Grolemund">
<title>R para Ciência de Dados (2ª edição) - 21&nbsp; ✅ Bancos de dados</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./arrow.html" rel="next">
<link href="./spreadsheets.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Nenhum resultado",
    "search-matching-documents-text": "documentos correspondentes",
    "search-copy-link-title": "Copiar link para a busca",
    "search-hide-matches-text": "Esconder correspondências adicionais",
    "search-more-match-text": "mais correspondência neste documento",
    "search-more-matches-text": "mais correspondências neste documento",
    "search-clear-button-title": "Limpar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Procurar"
  }
}</script><script defer="" data-domain="r4ds.hadley.nz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./import.html">✅ Importar</a></li><li class="breadcrumb-item"><a href="./databases.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">✅ Bancos de dados</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R para Ciência de Dados (2ª edição)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/cienciadedatos/pt-r4ds/" title="Código fonte" class="quarto-navigation-tool px-1" aria-label="Código fonte"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Alternar modo de leitor">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Procurar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Boas-vindas</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Prefácio da segunda edição</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Introdução</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Visão geral</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">✅ Visualização de dados</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">✅ Fluxo de Trabalho: básico</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data transformation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-style.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">✅ Fluxo de trabalho: estilo de código</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-tidy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">✅ Organizando os dados (<em>data tidying</em>)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">✅ Fluxo de trabalho: scripts e projetos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data import</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-help.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Workflow: getting help</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Visualizar</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">✅ Camadas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./EDA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Exploratory data analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Communication</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Transformar</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logicals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">✅ Vetores lógicos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">✅ Números</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Strings</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regexps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Regular expressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">✅ Fatores</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datetimes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Dates and times</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing-values.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">✅ Valores faltantes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Joins</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Importar</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spreadsheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Spreadsheets</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./databases.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">✅ Bancos de dados</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arrow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">✅ Arrow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rectangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Hierarchical data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./webscraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Web scraping</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Programar</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">✅ Funções</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Iteration</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">✅ Um guia para o R base</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./communicate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">✅ Comunicar</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Alternar seção">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">✅ Formatos para Quarto</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Índice</h2>
   
  <ul>
<li>
<a href="#introdu%C3%A7%C3%A3o" id="toc-introdução" class="nav-link active" data-scroll-target="#introdu%C3%A7%C3%A3o"><span class="header-section-number">21.1</span> Introdução</a>
  <ul class="collapse">
<li><a href="#pr%C3%A9-requisitos" id="toc-pré-requisitos" class="nav-link" data-scroll-target="#pr%C3%A9-requisitos"><span class="header-section-number">21.1.1</span> Pré-requisitos</a></li>
  </ul>
</li>
  <li><a href="#o-b%C3%A1sico-sobre-bancos-de-dados" id="toc-o-básico-sobre-bancos-de-dados" class="nav-link" data-scroll-target="#o-b%C3%A1sico-sobre-bancos-de-dados"><span class="header-section-number">21.2</span> O básico sobre bancos de dados</a></li>
  <li>
<a href="#conectando-a-um-banco-de-dados" id="toc-conectando-a-um-banco-de-dados" class="nav-link" data-scroll-target="#conectando-a-um-banco-de-dados"><span class="header-section-number">21.3</span> Conectando a um banco de dados</a>
  <ul class="collapse">
<li><a href="#neste-livro" id="toc-neste-livro" class="nav-link" data-scroll-target="#neste-livro"><span class="header-section-number">21.3.1</span> Neste livro</a></li>
  <li><a href="#sec-load-data" id="toc-sec-load-data" class="nav-link" data-scroll-target="#sec-load-data"><span class="header-section-number">21.3.2</span> Carregando alguns dados</a></li>
  <li><a href="#o-b%C3%A1sico-do-dbi" id="toc-o-básico-do-dbi" class="nav-link" data-scroll-target="#o-b%C3%A1sico-do-dbi"><span class="header-section-number">21.3.3</span> O básico do DBI</a></li>
  </ul>
</li>
  <li><a href="#o-b%C3%A1sico-do-dbplyr" id="toc-o-básico-do-dbplyr" class="nav-link" data-scroll-target="#o-b%C3%A1sico-do-dbplyr"><span class="header-section-number">21.4</span> O básico do dbplyr</a></li>
  <li>
<a href="#sql" id="toc-sql" class="nav-link" data-scroll-target="#sql"><span class="header-section-number">21.5</span> SQL</a>
  <ul class="collapse">
<li><a href="#o-b%C3%A1sico-do-sql" id="toc-o-básico-do-sql" class="nav-link" data-scroll-target="#o-b%C3%A1sico-do-sql"><span class="header-section-number">21.5.1</span> O básico do SQL</a></li>
  <li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select"><span class="header-section-number">21.5.2</span> SELECT</a></li>
  <li><a href="#from" id="toc-from" class="nav-link" data-scroll-target="#from"><span class="header-section-number">21.5.3</span> FROM</a></li>
  <li><a href="#group-by" id="toc-group-by" class="nav-link" data-scroll-target="#group-by"><span class="header-section-number">21.5.4</span> GROUP BY</a></li>
  <li><a href="#where" id="toc-where" class="nav-link" data-scroll-target="#where"><span class="header-section-number">21.5.5</span> WHERE</a></li>
  <li><a href="#order-by" id="toc-order-by" class="nav-link" data-scroll-target="#order-by"><span class="header-section-number">21.5.6</span> ORDER BY</a></li>
  <li><a href="#subconsultas" id="toc-subconsultas" class="nav-link" data-scroll-target="#subconsultas"><span class="header-section-number">21.5.7</span> Subconsultas</a></li>
  <li><a href="#uni%C3%B5es-joins" id="toc-uniões-joins" class="nav-link" data-scroll-target="#uni%C3%B5es-joins"><span class="header-section-number">21.5.8</span> Uniões (<em>Joins</em>)</a></li>
  <li><a href="#outros-verbos" id="toc-outros-verbos" class="nav-link" data-scroll-target="#outros-verbos"><span class="header-section-number">21.5.9</span> Outros verbos</a></li>
  <li><a href="#exerc%C3%ADcios" id="toc-exercícios" class="nav-link" data-scroll-target="#exerc%C3%ADcios"><span class="header-section-number">21.5.10</span> Exercícios</a></li>
  </ul>
</li>
  <li><a href="#sec-sql-expressions" id="toc-sec-sql-expressions" class="nav-link" data-scroll-target="#sec-sql-expressions"><span class="header-section-number">21.6</span> Tradução de funções</a></li>
  <li><a href="#resumo" id="toc-resumo" class="nav-link" data-scroll-target="#resumo"><span class="header-section-number">21.7</span> Resumo</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/cienciadedatos/pt-r4ds/edit/main/databases.qmd" class="toc-action"><i class="bi bi-github"></i>Editar essa página</a></li><li><a href="https://github.com/cienciadedatos/pt-r4ds/issues/new" class="toc-action"><i class="bi empty"></i>Criar uma issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./import.html">✅ Importar</a></li><li class="breadcrumb-item"><a href="./databases.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">✅ Bancos de dados</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-import-databases" class="quarto-section-identifier"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">✅ Bancos de dados</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="introdução" class="level2" data-number="21.1"><h2 data-number="21.1" class="anchored" data-anchor-id="introdução">
<span class="header-section-number">21.1</span> Introdução</h2>
<p>Um grande volume de dados são armazenados em bancos de dados (<em>databases</em>), portanto, é essencial que você saiba como acessá-los. Em alguns casos você pode pedir para alguém fazer uma cópia para um <code>.csv</code> para você, mas isto se torna problemático rapidamente: toda vez que você precisar fazer uma mudança, você precisará se comunicar com outra pessoa. Você deve ser capaz de acessar diretamente o banco de dados para obter os dados necessários quando quiser.</p>
<p>Neste capítulo, você aprenderá primeiro o básico do pacote DBI: como utilizá-lo para se conectar a um banco de dados e então obter dados através de uma consulta SQL<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. <strong>SQL</strong> é uma abreviação de <strong>s</strong><em>tructured</em> <strong>q</strong><em>uery</em> <strong>l</strong><em>anguage</em>, e é a lingua franca dos bancos de dados, portanto uma linguagem muito importante que todas pessoas que praticam ciência de dados devem aprender. Dito isto, não iremos começar com SQL, mas sim, iremos ensinar você sobre o dbplyr, um pacote capaz de traduzir código dplyr para código SQL. Faremos isto de maneira a ensinar algumas das características mais importantes do SQL. Você não se tornará um especialista em SQL ao final deste capítulo, mas será capaz de identificar a maioria de seus componentes principais e entender o que fazem.</p>
<section id="pré-requisitos" class="level3" data-number="21.1.1"><h3 data-number="21.1.1" class="anchored" data-anchor-id="pré-requisitos">
<span class="header-section-number">21.1.1</span> Pré-requisitos</h3>
<p>Neste capítulo, faremos uma introdução aos pacotes DBI e dbplyr. DBI é uma interface de baixo nível que se conecta aos bancos de dados e executa SQL; dbplyr é uma interface de alto nível que traduz seu código dplyr para um código de consultas SQL e então as executa através do DBI.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cienciadedatos/dados">dados</a></span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="o-básico-sobre-bancos-de-dados" class="level2" data-number="21.2"><h2 data-number="21.2" class="anchored" data-anchor-id="o-básico-sobre-bancos-de-dados">
<span class="header-section-number">21.2</span> O básico sobre bancos de dados</h2>
<p>Em um nível mais simples, você pode imaginar um banco de dados como uma coleção de <em>data frames</em>, que são chamados de <strong>tabelas</strong> na terminologia dos bancos de dados. Assim como um <em>data frame</em>, uma tabela de um banco de dados é uma coleção de colunas com nomes, onde cada valor na coluna tem o mesmo tipo. Existem três diferenças de alto nível entre <em>data frames</em> e as tabelas de um banco de dados:</p>
<ul>
<li><p>Tabelas são armazenadas em disco e podem ser arbitrariamente grandes. <em>Data frames</em> são armazenados na memória do computador, e são fundamentalmente limitados (apesar deste limite ser suficientemente grande para muitos problemas).</p></li>
<li><p>Tabelas quase sempre possuem um índice. Assim como um índice de um livro, um índice no banco de dados torna possível encontrar rapidamente as linhas de interesse, sem a necessidade de examinar uma a uma todas as linhas. <em>Data frames</em> e <em>tibbles</em> não possuem índices, porém <em>data.tables</em> possuem, e esta é umas das razões para serem tão rápidos.</p></li>
<li><p>Muitos bancos de dados clássicos são otimizados para coletar dados rapidamente, mas não para analizar dados existentes. Estes bancos de dados são chamados <strong>orientados à linhas</strong> (<em>row-oriented</em>), pois os dados são armazenados linha-a-linha ao invés de coluna-por-coluna como no R. Mais recentemente, tem-se visto o desenvolvimento de bancos de dados <strong>orientados à colunas</strong> (<em>column-oriented</em>), o que torna a análise de dados existentes mais rápida.</p></li>
</ul>
<p>Bancos de dados são executados por sistemas de gerenciamento de banco de dados (<strong>SGBD</strong>), os quais podem ser de três categorias:</p>
<ul>
<li>SGBDs <strong>Cliente-servidor</strong> rodam em um servidor central poderoso, ao qual você se conecta do seu computador (o cliente). Eles são muito bons para compartilhar dados com várias pessoas em uma organização. SGBDs cliente-servidor populares incluem o <em>PostgreSQL</em>, <em>MariaDB</em>, <em>SQL Server</em> e <em>Oracle</em>.</li>
<li>SGBDs na <strong>Nuvem</strong> (<em>Cloud</em>), como o <em>Snowflake</em>, <em>RedShift</em> da <em>Amazon</em> e o <em>BigQuery</em> do <em>Google</em>, são similares aos SGBDs cliente-servidor, mas eles rodam na nuvem. Isto significa que eles podem facilmente lidar com bancos de dados extremamente grandes e podem automaticamente obter mais recursos computacionais quando necessário.</li>
<li>SGBDs <strong>No-processo</strong> (<em>In-process</em>), como o <em>SQLite</em> ou <em>duckdb</em>, rodam inteiramente em seu computador. Eles são ótimos para trabalhar com conjunto de dados grandes nos quais você é o principal usuário.</li>
</ul></section><section id="conectando-a-um-banco-de-dados" class="level2" data-number="21.3"><h2 data-number="21.3" class="anchored" data-anchor-id="conectando-a-um-banco-de-dados">
<span class="header-section-number">21.3</span> Conectando a um banco de dados</h2>
<p>Para se conectar a um banco de dados pelo R, você usa um par de pacotes:</p>
<ul>
<li><p>Você sempre usuará o DBI (<strong>d</strong><em>ata</em><strong>b</strong><em>ase</em> <strong>i</strong><em>nterface</em>), pois este fornece um conjunto de funções genéricas que se conectam com os bancos de dados, enviam dados, executam consultas SQL, etc.</p></li>
<li><p>Você também usará um pacote feito especificamente para o SGBD ao qual você está se conectando. Este pacote traduz os comandos genéricos do DBI para as necessidades específicas de um determinado SGBD. Existe geralmente um pacote para cada SGBD, ex: RPostgres para <em>PostgreSQL</em> e RMariaDB para <em>MySQL</em>.</p></li>
</ul>
<p>Se você não puder encontrar um pacote específico para seu SGBD, você pode utilizar o pacote odbc. Este usa o protocolo ODBC suportado por muitos SGBDs. odbc exige uma configuração um pouco mais elaborada, pois você deve instalar o <em>driver</em> ODBC e informar o pacote odbc onde encontrá-lo.</p>
<p>Efetivamente, você cria uma conexão com o banco de dados usando <code><a href="https://dbi.r-dbi.org/reference/dbConnect.html">DBI::dbConnect()</a></code>. O primeiro argumento seleciona o SGBD<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, e os argumentos seguintes descrevem como se conectar a ele (ou seja, onde está localizado e as credenciais necessárias para acessá-lo). O código a seguir demonstra alguns exemplos típicos:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">RMariaDB</span><span class="fu">::</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html">MariaDB</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  username <span class="op">=</span> <span class="st">"foo"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html">Postgres</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  hostname <span class="op">=</span> <span class="st">"bancodados.minhaempresa.com"</span>, </span>
<span>  port <span class="op">=</span> <span class="fl">1234</span></span>
<span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Os detalhes precisos de conexão variam muito de SGBD para SGBD, portanto infelizmente não poderemos cobrir todos aqui. Isto significa que você deverá fazer um pouco de pesquisa por conta própria. Geralmente, você pode perguntar a outras pessoas cientistas de dados do time ou falar com a pessoa que administra o banco de dados (DBA) (<strong>d</strong>ata<strong>b</strong>ase <strong>a</strong>dministrator). A configuração inicial geralmente exige um pouco de ajuste (e talvez um pouco de pesquisa no <em>Google</em>) para ser feita corretamente, mas em geral você precisará fazer uma única vez.</p>
<section id="neste-livro" class="level3" data-number="21.3.1"><h3 data-number="21.3.1" class="anchored" data-anchor-id="neste-livro">
<span class="header-section-number">21.3.1</span> Neste livro</h3>
<p>Configurar um SGBD cliente-servidor ou SGBD da nuvem neste livro seria bastante chato, portanto usaremos um SGBD “no-processo” que vem inteiramente em um pacote do R: duckdb. Graças à magia do DBI, a única diferença entre usar o duckdb e outro SGBD é como você se conectará ao banco de dados. Isto se torna muito bom para ensinar, pois você pode executar facilmente este código e, da mesma forma, aplicar o que aprendeu em outros lugares com facilidade.</p>
<p>Conectar ao duckdb é particularmente simples, pois por padrão, um banco de dados temporário é criado e depois removido ao sair do R. Isto é muito bom para o aprendizado, pois garante que você iniciará de um estado limpo toda vez que reiniciar o R:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>duckdb é um banco de dados de alto desempenho desenhado muito para as necessidades da pessoa cientista de dados. O usaremos aqui pois é muito fácil de se iniciar, mas também porque é capaz de lidar com <em>gigabytes</em> de dados com grande velocidade. Se você quiser usar o duckdb em um projeto de análise de dados real, será necessário incluir o argumento <code>dbdir</code> para um banco de dados persistente e dizer ao duckdb onde salvar. Assumindo que você está usando um projeto (<a href="workflow-scripts.html" class="quarto-xref"><span>Capítulo 6</span></a>), é razoável armazená-lo no diretório <code>duckdb</code> do projeto atual:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="st">"duckdb"</span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-load-data" class="level3" data-number="21.3.2"><h3 data-number="21.3.2" class="anchored" data-anchor-id="sec-load-data">
<span class="header-section-number">21.3.2</span> Carregando alguns dados</h3>
<p>Já que este é um banco de dados novo, precisaremos começar adicionando alguns dados. Aqui adicionaremos os conjuntos de dados <code>milhas</code> e <code>diamante</code> do pacote dados usando <code><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">DBI::dbWriteTable()</a></code>. O exemplo de uso mais simples de <code><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable()</a></code> precisa de três argumentos: uma conexão ao banco de dados, o nome da tabela a ser criada no banco de dados e um <em>data frame</em> com os dados.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"milhas"</span>, <span class="fu">dados</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/dados/man/milhas.html">milhas</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"diamante"</span>, <span class="fu">dados</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/dados/man/diamante.html">diamante</a></span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Se você está usando o duckdb em um projeto real, recomendamos fortemente ler sobre <code>duckdb_read_csv()</code> e <code>duckdb_register_arrow()</code>. Estas funções te dão formas poderosas e de alto desempenho para carregar dados diretamente ao duckdb sem ter que os carregar primeiro no R. Nós também demonstraremos uma técnica útil para carregar vários arquivos em um banco de dados na <a href="iteration.html#sec-save-database" class="quarto-xref"><span>Seção 26.4.1</span></a>.</p>
</section><section id="o-básico-do-dbi" class="level3" data-number="21.3.3"><h3 data-number="21.3.3" class="anchored" data-anchor-id="o-básico-do-dbi">
<span class="header-section-number">21.3.3</span> O básico do DBI</h3>
<p>Você pode confirmar se os dados foram carregados corretamente usando um par de funções do DBI: <code><a href="https://dbi.r-dbi.org/reference/dbListTables.html">dbListTables()</a></code> lista todas as tabelas da banco de dados<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> e <code><a href="https://dbi.r-dbi.org/reference/dbReadTable.html">dbReadTable()</a></code> retorna o conteúdo de uma tabela.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListTables.html">dbListTables</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "diamante" "milhas"</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="st">"diamante"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 53,940 × 10</span></span>
<span><span class="co">#&gt;   preco quilate corte     cor   transparencia profundidade tabela     x     y</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt; &lt;fct&gt;                &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1   326    0.23 Ideal     E     SI2                   61.5     55  3.95  3.98</span></span>
<span><span class="co">#&gt; 2   326    0.21 Premium   E     SI1                   59.8     61  3.89  3.84</span></span>
<span><span class="co">#&gt; 3   327    0.23 Bom       E     VS1                   56.9     65  4.05  4.07</span></span>
<span><span class="co">#&gt; 4   334    0.29 Premium   I     VS2                   62.4     58  4.2   4.23</span></span>
<span><span class="co">#&gt; 5   335    0.31 Bom       J     SI2                   63.3     58  4.34  4.35</span></span>
<span><span class="co">#&gt; 6   336    0.24 Muito Bom J     VVS2                  62.8     57  3.94  3.96</span></span>
<span><span class="co">#&gt; # ℹ 53,934 more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: z &lt;dbl&gt;</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://dbi.r-dbi.org/reference/dbReadTable.html">dbReadTable()</a></code> retorna um <code>data.frame</code>, portanto usamos <code><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble()</a></code> para converter em um <em>tibble</em> para que imprima de forma mais bonita na tela.</p>
<p>Se você já sabe SQL, você pode usar <code><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery()</a></code> pata obter os resultados de uma consulta executada no banco de dados:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  SELECT quilate, corte, transparencia, cor, preco </span></span>
<span><span class="st">  FROM diamante </span></span>
<span><span class="st">  WHERE preco &gt; 15000</span></span>
<span><span class="st">"</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1,655 × 5</span></span>
<span><span class="co">#&gt;   quilate corte     transparencia cor   preco</span></span>
<span><span class="co">#&gt;     &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;         &lt;fct&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    1.54 Premium   VS2           E     15002</span></span>
<span><span class="co">#&gt; 2    1.19 Ideal     VVS1          F     15005</span></span>
<span><span class="co">#&gt; 3    2.1  Premium   SI1           I     15007</span></span>
<span><span class="co">#&gt; 4    1.69 Ideal     SI1           D     15011</span></span>
<span><span class="co">#&gt; 5    1.5  Muito Bom VVS2          G     15013</span></span>
<span><span class="co">#&gt; 6    1.73 Muito Bom VS1           G     15014</span></span>
<span><span class="co">#&gt; # ℹ 1,649 more rows</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Se você nunca viu SQL antes, não se preocupe! Em breve você aprenderá mais sobre isto. Mas se você ler atentamente, você pode adivinhar que estamos selecionando cinco colunas do conjunto de dados diamante e todas as linhas onde o <code>preco</code> é maior que 15.000.</p>
</section></section><section id="o-básico-do-dbplyr" class="level2" data-number="21.4"><h2 data-number="21.4" class="anchored" data-anchor-id="o-básico-do-dbplyr">
<span class="header-section-number">21.4</span> O básico do dbplyr</h2>
<p>Agora que você se conectou ao banco de dados e carregou alguns dados, você pode começar a aprender sobre dbplyr. dbplyr roda por tráz do dplyr, isso significa que você continua a escrever códigos dplyr, mas o <em>backend</em> o executa de maneira diferente. Neste caso, o dbplyr traduz para SQL; existem outros <em>backends</em> incluindo <a href="https://dtplyr.tidyverse.org">dtplyr</a> que traduz o código para <a href="https://r-datatable.com">data.table</a> e <a href="https://multidplyr.tidyverse.org">multidplyr</a> que executa o código em vários núcleos (<em>cores</em>).</p>
<p>Para usar dbplyr, primeiro você usa <code><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl()</a></code> para criar um objeto que representa a tabela do banco de dados:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diamantes_bd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"diamante"</span><span class="op">)</span></span>
<span><span class="va">diamantes_bd</span></span>
<span><span class="co">#&gt; # Source:   table&lt;diamante&gt; [?? x 10]</span></span>
<span><span class="co">#&gt; # Database: DuckDB v0.10.0 [root@Darwin 21.6.0:R 4.3.3/:memory:]</span></span>
<span><span class="co">#&gt;   preco quilate corte     cor   transparencia profundidade tabela     x     y</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt; &lt;fct&gt;                &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1   326    0.23 Ideal     E     SI2                   61.5     55  3.95  3.98</span></span>
<span><span class="co">#&gt; 2   326    0.21 Premium   E     SI1                   59.8     61  3.89  3.84</span></span>
<span><span class="co">#&gt; 3   327    0.23 Bom       E     VS1                   56.9     65  4.05  4.07</span></span>
<span><span class="co">#&gt; 4   334    0.29 Premium   I     VS2                   62.4     58  4.2   4.23</span></span>
<span><span class="co">#&gt; 5   335    0.31 Bom       J     SI2                   63.3     58  4.34  4.35</span></span>
<span><span class="co">#&gt; 6   336    0.24 Muito Bom J     VVS2                  62.8     57  3.94  3.96</span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: z &lt;dbl&gt;</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Existem duas outras formas comuns de interagir com banco de dados. Primeiro, muitas organizações possuem banco de dados muito grandes, então você precisa de alguma hierarquia para manter todas as tabelas organizadas. Neste caso, você deve precisar fornecer um esquema (<em>schema</em>) ou um catálogo (<em>catalog</em>) e um esquema, de maneira a obter a tabela que você tem interesse:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diamantes_bd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html">in_schema</a></span><span class="op">(</span><span class="st">"vendas"</span>, <span class="st">"diamante"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diamantes_bd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html">in_catalog</a></span><span class="op">(</span><span class="st">"america_norte"</span>, <span class="st">"vendas"</span>, <span class="st">"diamante"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Outras vezes você pode querer usar seu próprio SQL como ponto de partida:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diamantes_bd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"SELECT * FROM diamante"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Este é um objeto <strong>lazy</strong>; quando você usa verbos do dpluyr nele, dplyr não faz nada, ele apenas registra a sequência de operações que você deseja executar e as executa apenas quando necessário. Por exemplo, veja o seguinte <em>pipeline</em>:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grandes_diamantes_bd</span> <span class="op">&lt;-</span> <span class="va">diamantes_bd</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">preco</span> <span class="op">&gt;</span> <span class="fl">15000</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">quilate</span><span class="op">:</span><span class="va">transparencia</span>, <span class="va">preco</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grandes_diamantes_bd</span></span>
<span><span class="co">#&gt; # Source:   SQL [?? x 5]</span></span>
<span><span class="co">#&gt; # Database: DuckDB v0.10.0 [root@Darwin 21.6.0:R 4.3.3/:memory:]</span></span>
<span><span class="co">#&gt;   quilate corte     cor   transparencia preco</span></span>
<span><span class="co">#&gt;     &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt; &lt;fct&gt;         &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    1.54 Premium   E     VS2           15002</span></span>
<span><span class="co">#&gt; 2    1.19 Ideal     F     VVS1          15005</span></span>
<span><span class="co">#&gt; 3    2.1  Premium   I     SI1           15007</span></span>
<span><span class="co">#&gt; 4    1.69 Ideal     D     SI1           15011</span></span>
<span><span class="co">#&gt; 5    1.5  Muito Bom G     VVS2          15013</span></span>
<span><span class="co">#&gt; 6    1.73 Muito Bom G     VS1           15014</span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Você pode dizer que este objeto representa uma consulta ao banco de dados pois imprime o nome do SGBD no topo e apesar de também dizer o número de colunas, geralmente não sabe o número de linhas. Isso ocorre porque encontrar o número total de linhas geralmente requer a execução da consulta completa, algo que estamos tentando evitar.</p>
<p>Você também pode ver o código SQL gerado através da função <code><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query()</a></code> do dplyr. Se você conhece dplyr, esta é uma boa maneira de aprender SQL! Escreva algum código dplyr, deixe o dbplyr traduzir para o SQL, e então tente entender como as duas linguagens se relacionam.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grandes_diamantes_bd</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT quilate, corte, cor, transparencia, preco</span></span>
<span><span class="co">#&gt; FROM diamante</span></span>
<span><span class="co">#&gt; WHERE (preco &gt; 15000.0)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para puxar os dados de volta para o R, você chama a função <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code>. Por trás dos panos, isto gera o SQL, chama <code><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery()</a></code> para obter os dados, e então transforma o resultado em um <em>tibble</em>:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grandes_diamantes</span> <span class="op">&lt;-</span> <span class="va">grandes_diamantes_bd</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">grandes_diamantes</span></span>
<span><span class="co">#&gt; # A tibble: 1,655 × 5</span></span>
<span><span class="co">#&gt;   quilate corte     cor   transparencia preco</span></span>
<span><span class="co">#&gt;     &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt; &lt;fct&gt;         &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    1.54 Premium   E     VS2           15002</span></span>
<span><span class="co">#&gt; 2    1.19 Ideal     F     VVS1          15005</span></span>
<span><span class="co">#&gt; 3    2.1  Premium   I     SI1           15007</span></span>
<span><span class="co">#&gt; 4    1.69 Ideal     D     SI1           15011</span></span>
<span><span class="co">#&gt; 5    1.5  Muito Bom G     VVS2          15013</span></span>
<span><span class="co">#&gt; 6    1.73 Muito Bom G     VS1           15014</span></span>
<span><span class="co">#&gt; # ℹ 1,649 more rows</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Geralmente, você usará dbplyr para selecionar os dados que você deseja do conjunto de dados, efetuar alguns filtros básicos e agregações usando as traduções descritas abaixo. Então, assim que estiver pronto para analisar os dados com as funções que são únicas do R, você chamará <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> para obter os dados em um <em>tibble</em> na memória do seu computador, e continuará o trabalho com código R puro.</p>
</section><section id="sql" class="level2" data-number="21.5"><h2 data-number="21.5" class="anchored" data-anchor-id="sql">
<span class="header-section-number">21.5</span> SQL</h2>
<p>O resto do capítulo irá te ensinar um pouco de SQL pelas lentes do dbplyr. É uma introdução não tradicional ao SQL, mas esperamos que te leve rapidamente a um conhecimento básico. Felizmente, se você conhece dplyr você está em um bom lugar para rapidamente aprender SQL, pois muitos conceitos são iguais.</p>
<p>Nós iremos explorar o relacionamento entre dplyr e SQL usando alguns velhos amigos do pacote dados: <code>voos</code> e <code>avioes</code>. Estes conjuntos de dados são fáceis para usar no aprendizado sobre bancos de dados, e podemos copiá-las <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Copiando as tabelas para o banco de dados</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, name <span class="op">=</span> <span class="st">"voos"</span>, value <span class="op">=</span> <span class="va">voos</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, name <span class="op">=</span> <span class="st">"avioes"</span>, value <span class="op">=</span> <span class="va">avioes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lendo as tabelas do banco de dados</span></span>
<span><span class="va">voos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"voos"</span><span class="op">)</span></span>
<span><span class="va">avioes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"avioes"</span><span class="op">)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="o-básico-do-sql" class="level3" data-number="21.5.1"><h3 data-number="21.5.1" class="anchored" data-anchor-id="o-básico-do-sql">
<span class="header-section-number">21.5.1</span> O básico do SQL</h3>
<p>Os componentes de nível mais alto do SQL são chamados <strong>declarações</strong> (<em>statements</em>). Declarações comuns incluem <code>CREATE</code> para definir novas tableas, <code>INSERT</code> para adicionar dados e <code>SELECT</code> para retornar dados. Iremos focar em declarações <code>SELECT</code>, também chamadas de <strong>consultas</strong> (<em>queries</em>), pois são quase que exclusivamente o que você precisa para atuar em ciência de dados.</p>
<p>Um consulta é formada por <strong>cláusulas</strong> (<em>clauses</em>). Existem cinco cláusulas importantes: <code>SELECT</code>, <code>FROM</code>, <code>WHERE</code>, <code>ORDER BY</code> e <code>GROUP BY</code>. Toda consulta precisa ter cláusulas <code>SELECT</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> e <code>FROM</code><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> e a consulta mais simples é <code>SELECT * FROM tabela</code>, que seleciona todas colunas de determinada tabela . Isto é o que dbplyr gera de uma tabela sem mudanças :</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT *</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="va">avioes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT *</span></span>
<span><span class="co">#&gt; FROM avioes</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>WHERE</code> e <code>ORDER BY</code> controlam quais linhas serão incluídas e como estarão ordenadas:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">destino</span> <span class="op">==</span> <span class="st">"IAH"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">atraso_saida</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; WHERE (destino = 'IAH')</span></span>
<span><span class="co">#&gt; ORDER BY atraso_saida</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>GROUP BY</code> converte a consulta em uma sumarização, fazendo com que aconteça uma agregação:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">destino</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>atraso_saida <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">atraso_saida</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT destino, AVG(atraso_saida) AS atraso_saida</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; GROUP BY destino</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Existem duas principais diferenças entre verbos dplyr e cláusulas SELECT:</p>
<ul>
<li>No SQL, a maiúscula e minúscula não fazem diferença: você pode escrever <code>select</code>, <code>SELECT</code> ou até <code>SeLeCt</code>. Neste livro ficaremos com a convenção comum de escrever as palavras-chaves SQL usando letras maiúsculas para distinguir de nomes de tabelas ou variáveis.</li>
<li>No SQL, a ordem importa: você sempre deve escrever as declarações em ordem <code>SELECT</code>, <code>FROM</code>, <code>WHERE</code>, <code>GROUP BY</code>, <code>ORDER BY</code>. É um pouco confuso, pois esta ordem não é a mesma de como as declarações são realmente avaliadas com <code>FROM</code> em primeiro, depois <code>WHERE</code>, <code>GROUP BY</code>, <code>SELECT</code> e <code>ORDER BY</code>.</li>
</ul>
<p>As seções seguintes exploram com mais detalhes cada cláusula.</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Observe que apesar do SQL ser um padrão, ele é extramamente complexo e nenhum banco de dados o segue exatamente. Enquanto os componentes principais que iremos focar neste livro são muito similares entre os SGBDs, há muitas pequenas variações. Felizmente, dbplyr é desenhado para gerenciar este problema e gerar diferentes traduções para diferentes bancos de dados. Não é perfeito, mas está melhorando continuamente e se você encontrar um problema, pode abrir um caso (<em>issue</em>) <a href="https://github.com/tidyverse/dbplyr/issues/">no GitHub</a> para nos ajudar a melhorar.</p>
</div>
</div>
</div>
</section><section id="select" class="level3" data-number="21.5.2"><h3 data-number="21.5.2" class="anchored" data-anchor-id="select">
<span class="header-section-number">21.5.2</span> SELECT</h3>
<p>A cláusula <code>SELECT</code> é o motor das consultas e faz o mesmo trabalho que <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> e, como você aprenderá na próxima seção, <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> tem uma tradução muito direta para o <code>SELECT</code> já que apenas afetam onde uma coluna aparece (e se aparece) assim como seu nome:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">avioes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">codigo_cauda</span>, <span class="va">tipo</span>, <span class="va">fabricante</span>, <span class="va">modelo</span>, <span class="va">ano</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT codigo_cauda, tipo, fabricante, modelo, ano</span></span>
<span><span class="co">#&gt; FROM avioes</span></span>
<span></span>
<span><span class="va">avioes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">codigo_cauda</span>, <span class="va">tipo</span>, <span class="va">fabricante</span>, <span class="va">modelo</span>, <span class="va">ano</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>ano_construcao <span class="op">=</span> <span class="va">ano</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT codigo_cauda, tipo, fabricante, modelo, ano AS ano_construcao</span></span>
<span><span class="co">#&gt; FROM avioes</span></span>
<span></span>
<span><span class="va">avioes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">codigo_cauda</span>, <span class="va">tipo</span>, <span class="va">fabricante</span>, <span class="va">modelo</span>, <span class="va">ano</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">fabricante</span>, <span class="va">modelo</span>, .before <span class="op">=</span> <span class="va">tipo</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT codigo_cauda, fabricante, modelo, tipo, ano</span></span>
<span><span class="co">#&gt; FROM avioes</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Este exemplo também mostra como SQL renomeia. Na terminologia SQL, renomear é chamado de <strong>aliasing</strong> e é feito com <code>AS</code>. Note que diferente de <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, o nome antigo vai ao lado esquerdo e o novo nome ao lado direito.</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Nos exemplos acima, se tivéssemos os nomes de <code>"ano"</code> e <code>"tipo"</code>, elas apareceriam entre aspas duplas. Isto é devido a <em>year</em> e <em>type</em> serem palavras reservadas (<strong>reserved words</strong>) no duckdb, então dbplyr coloca aspas para evitar potencial confusão entre nome de colunas/tabelas e os operadores SQL.</p>
<p>Quando estiver trabalhando com outros bancos de dados é provavel que você veja todas as variáveis com aspas, pois apenas alguns poucos pacotes clientes, como o duckdb, sabem quais são todas as palavras reservadas, então eles colocam aspas em todas para evitar problemas.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="ot">"codigo_cauda"</span>, <span class="ot">"tipo"</span>, <span class="ot">"fabricante"</span>, <span class="ot">"modelo"</span>, <span class="ot">"ano"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="ot">"avioes"</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Alguns outros bancos de dados usam a crase ao invés de aspas duplas:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> `codigo_cauda`, `tipo`, `fabricante`, `modelo`, `ano`</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `avioes`</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>A tradução para <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> é da mesma forma bastante direta: cada variável se torna uma nova expressão no <code>SELECT</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    velocidade <span class="op">=</span> <span class="va">distancia</span> <span class="op">/</span> <span class="op">(</span><span class="va">tempo_voo</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*, distancia / (tempo_voo / 60.0) AS velocidade</span></span>
<span><span class="co">#&gt; FROM voos</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retornaremos para a tradução de componentes individuais (como <code>/</code>) na <a href="#sec-sql-expressions" class="quarto-xref"><span>Seção 21.6</span></a>.</p>
</section><section id="from" class="level3" data-number="21.5.3"><h3 data-number="21.5.3" class="anchored" data-anchor-id="from">
<span class="header-section-number">21.5.3</span> FROM</h3>
<p>A cláusula <code>FROM</code> define a fonte de dados. Será um pouco desinteressante por um período, pois estamos usando apenas uma única tabela. Você verá exemplos mais complexos quando chegarmos nas funções de união (<em>join</em>).</p>
</section><section id="group-by" class="level3" data-number="21.5.4"><h3 data-number="21.5.4" class="anchored" data-anchor-id="group-by">
<span class="header-section-number">21.5.4</span> GROUP BY</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> é traduzido como a clásula <code>GROUP BY</code><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> e <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> é traduzido como a cláusula <code>SELECT</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diamantes_bd</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">corte</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    avg_price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">preco</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT corte, COUNT(*) AS n, AVG(preco) AS avg_price</span></span>
<span><span class="co">#&gt; FROM diamante</span></span>
<span><span class="co">#&gt; GROUP BY corte</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retornaremos em o que acontece com a tradução de <code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code> e <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> na <a href="#sec-sql-expressions" class="quarto-xref"><span>Seção 21.6</span></a>.</p>
</section><section id="where" class="level3" data-number="21.5.5"><h3 data-number="21.5.5" class="anchored" data-anchor-id="where">
<span class="header-section-number">21.5.5</span> WHERE</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> é traduzido como a cláusula <code>WHERE</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">destino</span> <span class="op">==</span> <span class="st">"IAH"</span> <span class="op">|</span> <span class="va">destino</span> <span class="op">==</span> <span class="st">"HOU"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; WHERE (destino = 'IAH' OR destino = 'HOU')</span></span>
<span></span>
<span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">atraso_chegada</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">atraso_chegada</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; WHERE (atraso_chegada &gt; 0.0 AND atraso_chegada &lt; 20.0)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Existem alguns detalhes importantes a serem observados aqui:</p>
<ul>
<li>
<code>|</code> se torna <code>OR</code> e <code>&amp;</code> se torna <code>AND</code>.</li>
<li>SQL usa <code>=</code> para comparação, e não <code>==</code>. SQL não possui atribuição (<em>assignment</em>), portanto não há potencial para confusão aqui.</li>
<li>SQL usa somente <code>''</code> para <em>strings</em>, não usa <code>""</code>. No SQL, <code>""</code> é usado para identificar variáveis, como a <code>``</code> do R.</li>
</ul>
<p>Outro operator SQL útil é o <code>IN</code>, o qual se parece muito com o <code>%in%</code>do R:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">destino</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"IAH"</span>, <span class="st">"HOU"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; WHERE (destino IN ('IAH', 'HOU'))</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>SQL usa <code>NULL</code> ao invés de <code>NA</code>. <code>NULL</code> se comporta de forma similar ao <code>NA</code>. A principal diferença é que enquanto são considerados nas comparações e aritmética, eles são silenciosamente ignorados quando sumarizados. dbplyr irá te lembrar disto a primeira vez que você encontrar:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">destino</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>atraso <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">atraso_chegada</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Missing values are always removed in SQL aggregation functions.</span></span>
<span><span class="co">#&gt; Use `na.rm = TRUE` to silence this warning</span></span>
<span><span class="co">#&gt; This warning is displayed once every 8 hours.</span></span>
<span><span class="co">#&gt; # Source:   SQL [?? x 2]</span></span>
<span><span class="co">#&gt; # Database: DuckDB v0.10.0 [root@Darwin 21.6.0:R 4.3.3/:memory:]</span></span>
<span><span class="co">#&gt;   destino atraso</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 CLT      7.36 </span></span>
<span><span class="co">#&gt; 2 MDW     12.4  </span></span>
<span><span class="co">#&gt; 3 HOU      7.18 </span></span>
<span><span class="co">#&gt; 4 SDF     12.7  </span></span>
<span><span class="co">#&gt; 5 LAS      0.258</span></span>
<span><span class="co">#&gt; 6 PHX      2.10 </span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Se você quiser saber mais em como o <code>NULL</code> funciona, você irá gostar do artigo “<a href="https://modern-sql.com/concept/three-valued-logic"><em>Three valued logic</em></a>” de Markus Winand.</p>
<p>Em geral, você pode trabalhar com <code>NULL</code> usando as funções que você usaria para <code>NA</code> no R:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">atraso_saida</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; WHERE (NOT((atraso_saida IS NULL)))</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esta consulta SQL ilustra uma das desvatagens do dbplyr: apesar do SQL estar correto, ela não é tão simples quanto se estivesse sido escrita à mão. Neste caso, você poderia eliminar os parênteses e usar um operador especial que é mais simples de se ler:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="ot">"atraso_saida"</span> <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note que se você usar <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> em uma variável que você criou usando um summarize, dbplyr irá gerar uma cláusula <code>HAVING</code>, ao invés de uma cláusula <code>WHERE</code>. Esta é uma das indiosincrasias do SQL: <code>WHERE</code> é avaliado antes do <code>SELECT</code> e <code>GROUP BY</code>, então o SQL precisa de uma outra cláusula que seja avaliada depois.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diamantes_bd</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">corte</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT corte, COUNT(*) AS n</span></span>
<span><span class="co">#&gt; FROM diamante</span></span>
<span><span class="co">#&gt; GROUP BY corte</span></span>
<span><span class="co">#&gt; HAVING (COUNT(*) &gt; 100.0)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="order-by" class="level3" data-number="21.5.6"><h3 data-number="21.5.6" class="anchored" data-anchor-id="order-by">
<span class="header-section-number">21.5.6</span> ORDER BY</h3>
<p>Ordenar linhas involve uma tradução direta de <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> para a cláusula <code>ORDER BY</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">ano</span>, <span class="va">mes</span>, <span class="va">dia</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">atraso_saida</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT voos.*</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; ORDER BY ano, mes, dia, atraso_saida DESC</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note como <code><a href="https://dplyr.tidyverse.org/reference/desc.html">desc()</a></code> é traduzido para <code>DESC</code>: esta é uma das muitas funções dplyr cujo o nome foi diretamente inspirado pelo SQL.</p>
</section><section id="subconsultas" class="level3" data-number="21.5.7"><h3 data-number="21.5.7" class="anchored" data-anchor-id="subconsultas">
<span class="header-section-number">21.5.7</span> Subconsultas</h3>
<p>Algumas vezes não é possível traduzir um <em>pipeline</em> dplyr em uma única declaração <code>SELECT</code> e você precisa usar uma subconsulta. Uma <strong>subconsulta</strong> é apenas uma consulta usada como uma fonte de dados na cláusula <code>FROM</code> ao invés de uma tabela normal.</p>
<p>O dbplyr tipicamente usa subconsultas para solucionar paleativamente limitações do SQL. Por exemplo, expressões na cláusula <code>SELECT</code> não podem referenciar colunas que acabaram de ser criadas. Isto significa que o seguinte <em>pipeline</em> (muito simples) precisa acontecer em duas etapas: a primeira consulta (interna) computa <code>ano1</code> e então a segunda consulta (externa) pode computar <code>ano2</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    ano1 <span class="op">=</span> <span class="va">ano</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    ano2 <span class="op">=</span> <span class="va">ano1</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT q01.*, ano1 + 1.0 AS ano2</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT voos.*, ano + 1.0 AS ano1</span></span>
<span><span class="co">#&gt;   FROM voos</span></span>
<span><span class="co">#&gt; ) q01</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Você também verá isso se tentar filtrar com <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> a variável que você criou recentemente. Lembre-se que, apesar de <code>WHERE</code> ser escrita depois de <code>SELECT</code>, ela é avaliada antes, por isso você precisa de uma subconsulta neste simples exemplo:</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ano1 <span class="op">=</span> <span class="va">ano</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ano1</span> <span class="op">==</span> <span class="fl">2014</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT q01.*</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT voos.*, ano + 1.0 AS ano1</span></span>
<span><span class="co">#&gt;   FROM voos</span></span>
<span><span class="co">#&gt; ) q01</span></span>
<span><span class="co">#&gt; WHERE (ano1 = 2014.0)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Algumas vezes, dbplyr irá criar uma subconsulta mesmo onde não é necessário, pois não sabe ainda como otimizar tal tradução. Conforme dbplyr melhora, estes casos vão ficando mais raros, mas provavelmente nunca desaparecerão por completo.</p>
</section><section id="uniões-joins" class="level3" data-number="21.5.8"><h3 data-number="21.5.8" class="anchored" data-anchor-id="uniões-joins">
<span class="header-section-number">21.5.8</span> Uniões (<em>Joins</em>)</h3>
<p>Se você está familiarizado com uniões (<em>joins</em>) com dplyr, as uniões do SQL são bem parecidas. Aqui está um exemplo simples:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">avioes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>ano_construcao <span class="op">=</span> <span class="va">ano</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"codigo_cauda"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT</span></span>
<span><span class="co">#&gt;   voos.*,</span></span>
<span><span class="co">#&gt;   avioes.ano AS ano_construcao,</span></span>
<span><span class="co">#&gt;   tipo,</span></span>
<span><span class="co">#&gt;   fabricante,</span></span>
<span><span class="co">#&gt;   modelo,</span></span>
<span><span class="co">#&gt;   motores,</span></span>
<span><span class="co">#&gt;   assentos,</span></span>
<span><span class="co">#&gt;   velocidade,</span></span>
<span><span class="co">#&gt;   tipo_motor</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; LEFT JOIN avioes</span></span>
<span><span class="co">#&gt;   ON (voos.codigo_cauda = avioes.codigo_cauda)</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A principal coisa a se notar aqui é a sintaxe: as uniões SQL usam sub-cláusulas da cláusula <code>FROM</code> para associar tabelas adicionais, usando <code>ON</code> para definir como as tabelas estão relacionadas.</p>
<p>Os nomes das funções dplyr são tão parecidas com as do SQL que você pode facilmente adivinhar o SQL equivalente para <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> voos.<span class="op">*</span>, <span class="ot">"tipo"</span>, fabricante, modelo, motores, assentos, velocidade</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> voos</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> avioes <span class="kw">ON</span> (voos.codigo_cauda <span class="op">=</span> avioes.codigo_cauda)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> voos.<span class="op">*</span>, <span class="ot">"tipo"</span>, fabricante, modelo, motores, assentos, velocidade</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> voos</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">RIGHT</span> <span class="kw">JOIN</span> avioes <span class="kw">ON</span> (voos.codigo_cauda <span class="op">=</span> avioes.codigo_cauda)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> voos.<span class="op">*</span>, <span class="ot">"tipo"</span>, fabricante, modelo, motores, assentos, velocidade</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> voos</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FULL</span> <span class="kw">JOIN</span> avioes <span class="kw">ON</span> (voos.codigo_cauda <span class="op">=</span> avioes.codigo_cauda)</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>É muito provavel que você precise de muitas uniões (<em>joins</em>) quando trabalhar com dados de um banco de dados. Isto porque tabelas são frequentemente armazenadas de uma forma altamente normalizada, onde cada “fato” é armazenado em um único local e para manter um conjunto de dados completo para análise, você precisa navegar por uma rede complexa de tabelas conectadas por chaves primárias (<em>primary key</em>) e chaves estrangeiras (<em>foreign key</em>). Se você encontrar este cenário, o <a href="https://cynkra.github.io/dm/">pacote dm</a>, de Tobias Schieferdecker, Kirill Müller e Darko Bergant é um salva-vidas. Ele pode automaticamente determinar as conexões entre as tabelas usando restrições (<em>constraints</em>) que as pessoas que adminstram bancos de dados (DBAs) geralmente fornecem, gera visualizações para que você entenda o que está acontecendo e gera as uniões (<em>joins</em>) que você precisa para conectar uma tabela à outra.</p>
</section><section id="outros-verbos" class="level3" data-number="21.5.9"><h3 data-number="21.5.9" class="anchored" data-anchor-id="outros-verbos">
<span class="header-section-number">21.5.9</span> Outros verbos</h3>
<p>O dbplyr também traduz outros verbos como <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code>, <code>slice_*()</code>, <code><a href="https://generics.r-lib.org/reference/setops.html">intersect()</a></code>, e uma seleção crescente de funções do tidyr como <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> e <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code>. O jeito mais fácil de ver a lista completa do que está disponível no momento é visitando o website dbplyr: <a href="https://dbplyr.tidyverse.org/reference/" class="uri">https://dbplyr.tidyverse.org/reference/</a>.</p>
</section><section id="exercícios" class="level3" data-number="21.5.10"><h3 data-number="21.5.10" class="anchored" data-anchor-id="exercícios">
<span class="header-section-number">21.5.10</span> Exercícios</h3>
<ol type="1">
<li><p>Em que se traduz a <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code>? E a <code><a href="https://rdrr.io/r/utils/head.html">head()</a></code>?</p></li>
<li>
<p>Explique o que cada um desses comandos SQL fazem e tente recriá-los usando dbplyr.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> voos</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> atraso_saida <span class="op">&lt;</span> atraso_chegada</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, distancia <span class="op">/</span> (tempo_voo <span class="op">/</span> <span class="dv">60</span>) <span class="kw">AS</span> velocidade</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> voos</span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</li>
</ol></section></section><section id="sec-sql-expressions" class="level2" data-number="21.6"><h2 data-number="21.6" class="anchored" data-anchor-id="sec-sql-expressions">
<span class="header-section-number">21.6</span> Tradução de funções</h2>
<p>Até agora focamos na visão geral de como os verbos dplyr são traduzidos para cláusulas em uma consulta. Agora iremos focar um pouco mais e falar sobre a tradução de funções do R que trabalham com colunas, por exemplo, o que acontece quando você usa <code>mean(x)</code> em um <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>?</p>
<p>Para ajudar a entender o que acontece, usaremos algumas funções de ajuda que chamam um <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> ou <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> and mostram o SQL produzido. Isto tornará um pouco mais fácil explorar algumas variações e ver como sumarizações e transformações podem ser diferentes.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">consulta_summarize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">consulta_mutate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">...</span>, .keep <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Vamos mergulhar em algumas sumarizações! Olhando o código abaixo, você perceberá que algumas funções de sumarização como <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>, tem uma tradução relativamente simples, enquanto outras, como <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code> são muito mais complexas. Esta complexidade é geralmente maior para operações que são comuns na estatística mas menos comuns em bancos de dados.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ano</span>, <span class="va">mes</span>, <span class="va">dia</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">consulta_summarize</span><span class="op">(</span></span>
<span>    media <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">atraso_chegada</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    mediana <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">atraso_chegada</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by "ano" and "mes". You can override using</span></span>
<span><span class="co">#&gt; the `.groups` argument.</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT</span></span>
<span><span class="co">#&gt;   ano,</span></span>
<span><span class="co">#&gt;   mes,</span></span>
<span><span class="co">#&gt;   dia,</span></span>
<span><span class="co">#&gt;   AVG(atraso_chegada) AS media,</span></span>
<span><span class="co">#&gt;   PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY atraso_chegada) AS mediana</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; GROUP BY ano, mes, dia</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A tradução de funções de sumarização se tornam mais complicadas quando você as usa dentro de um <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> pois elas se transformam naquilo que conhecemos como <strong>funções de janela</strong> (<em>window functions</em>). No SQL, você transforma uma funções normal em uma função de janela adicionando <code>OVER</code> depois dela:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ano</span>, <span class="va">mes</span>, <span class="va">dia</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">consulta_mutate</span><span class="op">(</span></span>
<span>    media <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">atraso_chegada</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT</span></span>
<span><span class="co">#&gt;   ano,</span></span>
<span><span class="co">#&gt;   mes,</span></span>
<span><span class="co">#&gt;   dia,</span></span>
<span><span class="co">#&gt;   AVG(atraso_chegada) OVER (PARTITION BY ano, mes, dia) AS media</span></span>
<span><span class="co">#&gt; FROM voos</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No SQL, a clásula <code>GROUP BY</code> é usada exclusivamente para sumarizações, portanto aqui você pode ver que o agrupamento foi movido do argumento <code>PARTITION BY</code> para o <code>OVER</code>.</p>
<p>Funções de janela incluem todas as funções que olham para trás ou para frente como <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag()</a></code> que olham para os valores “anteriores” ou “posteriores” respectivamente:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">destino</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">data_hora</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">consulta_mutate</span><span class="op">(</span></span>
<span>    lead <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span><span class="op">(</span><span class="va">atraso_chegada</span><span class="op">)</span>,</span>
<span>    lag <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">atraso_chegada</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT</span></span>
<span><span class="co">#&gt;   destino,</span></span>
<span><span class="co">#&gt;   LEAD(atraso_chegada, 1, NULL) OVER (PARTITION BY destino ORDER BY data_hora) AS lead,</span></span>
<span><span class="co">#&gt;   LAG(atraso_chegada, 1, NULL) OVER (PARTITION BY destino ORDER BY data_hora) AS lag</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span><span class="co">#&gt; ORDER BY data_hora</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Aqui é importante ordenar com <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> os dados, pois tabelas SQL não possuem um ordem intrínseca. Na verdade, se você não usar <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> você pode obter resultados em ordens diferentes toda vez! Note que nas funções de janela, a ordenação da informação se repete: a cláusula <code>ORDER BY</code> da consulta principal não se aplica automaticamente às funções de janela.</p>
<p>Outra função SQL importante é a <code>CASE WHEN</code>. É usada para traduzir as funções <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> que dplyr se inspirou diretamente. Aqui estão alguns exemplos simples:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">consulta_mutate</span><span class="op">(</span></span>
<span>    descricao <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">atraso_chegada</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"atrasado"</span>, <span class="st">"no horario"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT CASE WHEN (atraso_chegada &gt; 0.0) THEN 'atrasado' WHEN NOT (atraso_chegada &gt; 0.0) THEN 'no horario' END AS descricao</span></span>
<span><span class="co">#&gt; FROM voos</span></span>
<span></span>
<span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">consulta_mutate</span><span class="op">(</span></span>
<span>    descricao <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">atraso_chegada</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">5</span> <span class="op">~</span> <span class="st">"adiantado"</span>, </span>
<span>        <span class="va">atraso_chegada</span> <span class="op">&lt;</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"no horario"</span>,</span>
<span>        <span class="va">atraso_chegada</span> <span class="op">&gt;=</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"atrasado"</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT CASE</span></span>
<span><span class="co">#&gt; WHEN (atraso_chegada &lt; -5.0) THEN 'adiantado'</span></span>
<span><span class="co">#&gt; WHEN (atraso_chegada &lt; 5.0) THEN 'no horario'</span></span>
<span><span class="co">#&gt; WHEN (atraso_chegada &gt;= 5.0) THEN 'atrasado'</span></span>
<span><span class="co">#&gt; END AS descricao</span></span>
<span><span class="co">#&gt; FROM voos</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>CASE WHEN</code> também é usado para algumas funções que não tem tradução direta do R para o SQL. Um bom exemplo disso é <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voos</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">consulta_mutate</span><span class="op">(</span></span>
<span>    descricao <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">atraso_chegada</span>, </span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="cn">Inf</span><span class="op">)</span>, </span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adiantado"</span>, <span class="st">"no horario"</span>, <span class="st">"atrasado"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT CASE</span></span>
<span><span class="co">#&gt; WHEN (atraso_chegada &lt;= -5.0) THEN 'adiantado'</span></span>
<span><span class="co">#&gt; WHEN (atraso_chegada &lt;= 5.0) THEN 'no horario'</span></span>
<span><span class="co">#&gt; WHEN (atraso_chegada &gt; 5.0) THEN 'atrasado'</span></span>
<span><span class="co">#&gt; END AS descricao</span></span>
<span><span class="co">#&gt; FROM voos</span></span></code><button title="Copiar para a área de transferência" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O dbplyr também traduz funções comuns de manipulação de <em>string</em> e data/hora (<em>datetime</em>), as quais você pode aprender sobre na <code><a href="https://dbplyr.tidyverse.org/articles/translation-function.html">vignette("translation-function", package = "dbplyr")</a></code>. As traduções do dbplyr certamente não são perfeitas, e ainda existem muitas funções do R que ainda não são traduzidas, mas o dbplyr faz um surpreendente bom trabalho em traduzir as funções que você usará na maior parte do tempo.</p>
</section><section id="resumo" class="level2" data-number="21.7"><h2 data-number="21.7" class="anchored" data-anchor-id="resumo">
<span class="header-section-number">21.7</span> Resumo</h2>
<p>Neste capítulo você aprendeu como acessar dados de um banco de dados. Nós focamos no dbplyr, um “<em>backend</em>” do dplyr que permite que você escreva o código dplyr que está familiarizado e o tenha automaticamente traduzido em SQL. Nós utilizamos esta tradução para te ensinar um pouco de SQL; é importante aprender SQL pois é <em>a</em> linguagem mais comumente utilizada para se trabalhar com dados e conhecê-la um pouco facilitrá sua comunicação com outras pessoas de dados que não usam o R. Se você terminou este capítulo e gostaria de aprender mais sobre SQL. Nós temos duas recomendações:</p>
<ul>
<li>
<a href="https://sqlfordatascientists.com"><em>SQL for Data Scientists</em></a> de Renée M. P. Teate é uma introdução ao SQL desenhada especificamente para as necessidades de cientistas de dados e inclui exemplos com dados altamente interconectados que você geralmente encontra em organizações reais.</li>
<li>
<a href="https://www.practicalsql.com"><em>Practical SQL</em></a> de Anthony DeBarros é escrito sob a perspectiva de uma pessoa jornalista de dados (cientista de dados especialista em contar histórias atraentes) e entra em mais detalhes sobre ter seus dados em um banco de dados e rodar seu próprio SGBD.</li>
</ul>
<p>No próximo capítulo, você aprenderá sobre outro <em>backend</em> dplyr para trabalhar com grandes volumes de dados: <em>arrow</em>. Arrow é desenhado para trabalhar com grandes arquivos em disco e é um complemento natural aos bancos de dados.</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>SQL é pronunciado “s”-“q”-“l”.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Normalmente, esta é a única função que você usará do pacote cliente, por isso recomendamos usar o <code>::</code> para referenciar esta função específica, ao invés de carregar todo o pacote usando <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Ao menos, todas as tabelas que você tem permissão para ver.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><strong>Nota de tradução</strong>: O pacote <a href="https://dbplyr.tidyverse.org/">dbplyr</a> vem com a função <code><a href="https://dbplyr.tidyverse.org/reference/nycflights13.html">dbplyr::copy_nycflights13()</a></code> que copia as tabelas originais, em inglês, para o banco de dados. Como estamos utilizando os dados traduzidos, disponíveis no pacote <a href="https://github.com/cienciadedatos/dados">dados</a>, vamos copiar as tabelas traduzidas para o banco de dados utilizando a função <code><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html">dbWriteTable()</a></code> do pacote <a href="https://dbi.r-dbi.org">DBI</a>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>É estranho, mas dependendo do contexto, <code>SELECT</code> pode ser tanto uma declaração quanto uma cláusula. Para evitar esta confusão, iremos usar uma <strong>consulta</strong> <code>SELECT</code> ao invés de um declaração <code>SELECT</code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Ok, tecnicamente, somente o <code>SELECT</code> é necessário, já que você pode escrever consultas como <code>SELECT 1+1</code> para executar cálculos básicos. Mas se você quer trabalhar com dados (como você faz sempre!) você precisará da cláusula <code>FROM</code>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Isto não é uma coincidência: A função dplyr foi inspirada na cláusula SQL.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiada");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiada");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./spreadsheets.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Spreadsheets</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./arrow.html" class="pagination-link" aria-label="<span class='chapter-number'>22</span>&nbsp; <span class='chapter-title'>✅ Arrow</span>">
        <span class="nav-page-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">✅ Arrow</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>R para Ciência de Dados (2ª edição) foi escrito por Hadley Wickham, Mine Çetinkaya-Rundel, e Garrett Grolemund.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/cienciadedatos/pt-r4ds/edit/main/databases.qmd" class="toc-action"><i class="bi bi-github"></i>Editar essa página</a></li><li><a href="https://github.com/cienciadedatos/pt-r4ds/issues/new" class="toc-action"><i class="bi empty"></i>Criar uma issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Este livro foi contruído com <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>